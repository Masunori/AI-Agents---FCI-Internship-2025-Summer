name: Daily PDF and MD Report Generation

on:
    schedule:
        - cron: '30 9 * * *'  # Runs daily at 16:40 UTC+8
    workflow_dispatch:
        
jobs:
    generate_reports:
        runs-on: windows-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.12.10'

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Run framework to generate reports
              env:
                  FPT_120B: ${{ secrets.FPT_120B }}
                  FPT_API_KEY: ${{ secrets.FPT_API_KEY }}
                  DEDUPLICATION_DB_PATH: ${{ secrets.DEDUPLICATION_DB_PATH }}
              run: |
                  python FCI_NewsAgents/main.py --pdf-path ./output

            - name: Upload generated PDF to GitHub Release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              shell: pwsh
              run: |
                  $DATE = (Get-Date).ToString('yyyy-MM-dd')
                  gh release delete "daily-report" --yes || $true
                  gh release create "daily-report" "./output/ai_news_report_$DATE.pdf" --title "Daily Report $DATE" --notes "Automated daily report generated on $DATE"

            - name: Notify Microsoft Teams
              env:
                  TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
              shell: pwsh
              run: |
                  $DATE = (Get-Date).ToString('yyyy-MM-dd')
                  $PDF_URL = "https://github.com/${{ github.repository }}/releases/download/daily-report/ai_news_report_$DATE.pdf"

                  curl -X POST $env:TEAMS_WEBHOOK_URL `
                    -H 'Content-Type: application/json' `
                    -d '{
                        "type": "message",
                        "attachments": [
                            {
                                "contentType": "application/vnd.microsoft.card.adaptive",
                                "content": {
                                    "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                                    "type": "AdaptiveCard",
                                    "version": "1.4",
                                    "body": [
                                        {
                                            "type": "TextBlock",
                                            "size": "Medium",
                                            "weight": "Bolder",
                                            "text": "Daily AI News Report"
                                        },
                                        {
                                            "type": "TextBlock",
                                            "text": "The daily AI news report has been generated. [Click here to view the PDF report.]('"$PDF_URL"')",
                                            "wrap": true
                                        }
                                    ]
                                }
                            }
                        ]
                    }'