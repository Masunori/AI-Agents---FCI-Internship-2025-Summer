name: Daily PDF and MD Report Generation

on:
    schedule:
        - cron: '0 9 * * *'  # Runs daily at 17:00 UTC+8
    workflow_dispatch:
        
jobs:
    generate_reports:
        runs-on: windows-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.12.10'

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r FCI_NewsAgents/requirements.txt

            - name: Run framework to generate reports
              run: |
                  python FCI_NewsAgents/main.py --pdf-path ./output

            - name: Upload generated PDF to GitHub Release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  gh release delete "daily-report" --yes || true
                  gh release create "daily-report" ./output/ai_news_report.pdf --title "Daily Report $(date +'%Y-%m-%d')" --notes "Automated daily report generated on $(date +'%Y-%m-%d')"

            - name: Notify Microsoft Teams
              env:
                  TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
              run: |
                  PDF_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/daily-report/ai_news_report.pdf"

                  curl -X POST $TEAMS_WEBHOOK_URL \
                    -H 'Content-Type: application/json' \
                    -d '{
                        "title": "Daily AI News Report",
                        "text": "The daily AI news report has been generated. [Click here to view the PDF report.]('"$PDF_URL"')"
                    }'