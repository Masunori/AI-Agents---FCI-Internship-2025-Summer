name: Daily PDF and MD Report Generation

on:
    schedule:
        - cron: '30 9 * * *'  # Runs daily at 16:40 UTC+8
    workflow_dispatch:
        
jobs:
    generate_reports:
        runs-on: windows-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.12.10'

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Run framework to generate reports
              env:
                  FPT_120B: ${{ secrets.FPT_120B }}
                  FPT_API_KEY: ${{ secrets.FPT_API_KEY }}
                  DEDUPLICATION_DB_PATH: ${{ secrets.DEDUPLICATION_DB_PATH }}
              run: |
                  python FCI_NewsAgents/main.py --pdf-path ./output

            - name: Create docs directory and copy PDF
              shell: pwsh
              run: |
                  if (-not (Test-Path "docs")) {
                      New-Item -ItemType Directory -Path "docs" | Out-Null
                  }
                  $DATE = (Get-Date).ToString('yyyy-MM-dd')
                  Copy-Item "./output/ai_news_report_$DATE.pdf" "docs/ai_news_report_$DATE.pdf"
                  
                  # Create a simple HTML index page to display the PDF
                  $htmlContent = @"
                  <!DOCTYPE html>
                  <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>AI News Report</title>
                        <style>
                            body {
                                font-family: Arial, sans-serif;
                                background-color: #f5f5f5;
                            }
                            iframe {
                                width: 98vw;
                                height: 98vh;
                                border: none;
                                padding: 0;
                                overflow: hidden;
                            }
                        </style>
                    </head>
                    <body>
                        <iframe src="ai_news_report_$DATE.pdf"></iframe>
                    </body>
                  </html>
                  "@
                  
                  $htmlContent | Out-File -FilePath "docs/index.html" -Encoding UTF8

            - name: Upload generated PDF to GitHub Release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              shell: pwsh
              run: |
                  $DATE = (Get-Date).ToString('yyyy-MM-dd')
                  gh release delete "daily-report" --yes || $true
                  gh release create "daily-report" "./output/ai_news_report_$DATE.pdf" --title "Daily Report $DATE" --notes "Automated daily report generated on $DATE"

            - name: Push docs folder to GitHub Pages
              shell: pwsh
              run: |
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"
                  git add docs/
                  git commit -m "Update docs with generated PDF report" || $true
                  git push

            - name: Notify Microsoft Teams
              env:
                  TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
              shell: pwsh
              run: |
                  $DATE = (Get-Date).ToString('yyyy-MM-dd')
                  $PAGES_URL = "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"

                  $payload = @{
                      type = "message"
                      attachments = @(
                          @{
                              contentType = "application/vnd.microsoft.card.adaptive"
                              content = @{
                                  "$schema" = "http://adaptivecards.io/schemas/adaptive-card.json"
                                  type = "AdaptiveCard"
                                  version = "1.4"
                                  body = @(
                                      @{
                                          type = "TextBlock"
                                          size = "Medium"
                                          weight = "Bolder"
                                          text = "Daily AI News Report"
                                      },
                                      @{
                                          type = "TextBlock"
                                          text = "The daily AI news report has been generated. [Click here to view the PDF report.]($PAGES_URL)"
                                          wrap = $true
                                      }
                                  )
                              }
                          }
                      )
                  }

                  $jsonPayload = $payload | ConvertTo-Json -Depth 10

                  curl -X POST $env:TEAMS_WEBHOOK_URL `
                    -H 'Content-Type: application/json' `
                                        -d $jsonPayload